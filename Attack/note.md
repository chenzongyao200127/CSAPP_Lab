# Note

ROP攻击，全称为“返回导向编程（Return-Oriented Programming）攻击”，是一种高级的软件漏洞利用技术。它允许攻击者在没有执行任何新代码的情况下，通过利用已存在于程序或其库中的代码片段（称为“小工具”）来绕过某些安全防护措施，如非可执行栈。ROP攻击通常用于绕过执行防护，如DEP（数据执行防止）。

为了理解ROP攻击，我们需要先了解一些基础知识：

1. **栈（Stack）**：计算机内存中用于存储局部变量和管理函数调用的区域。

2. **栈溢出（Stack Overflow）**：当程序写入的数据超出其在栈上分配的空间时，就会发生栈溢出，这可能覆盖控制流信息，如返回地址。

3. **非可执行栈（Non-Executable Stack）**：为了防止栈溢出攻击，现代操作系统通常使栈不可执行，这意味着栈上不能直接执行二进制代码。

ROP攻击的工作原理如下：

- **找到小工具**：攻击者首先在存在漏洞的程序或其库文件中寻找有用的代码片段，这些代码片段以“返回”指令结束，被称为“小工具”。

- **控制栈**：通过某种方式（如栈溢出），攻击者覆盖栈上的数据，包括返回地址。这些返回地址被修改为指向他们所选的小工具的地址。

- **执行小工具链**：当程序执行流到达一个被修改的返回地址时，它会跳转到相应的小工具。每个小工具执行一个小操作（如移动数据、执行算术操作等），然后通过其自身的返回指令跳转到下一个小工具。通过这种方式，攻击者可以“拼接”这些小操作来完成更复杂的任务，比如绕过安全措施或执行恶意代码。

ROP攻击的关键在于，它不需要在目标系统上注入或执行新的代码，而是仅仅重新组合和利用已存在的代码片段。这使得它非常难以检测和防御，因为它利用的是程序本身合法的、正常的代码。

好的，我来尝试用更通俗的方式解释什么是ROP攻击（返回导向编程攻击）：

想象一下，有一个非常严格的图书管理员，他不允许你在图书馆里带入自己的书籍。但你想读一本图书馆没有的特别的故事书。这时，你想到了一个聪明的计划：利用图书馆已经有的书籍来“创造”你想读的故事。

在这个计划中，你先在图书馆找到许多不同的书，每本书都有一两句你需要的故事线。然后，你把这些句子的顺序重新排列，组成一个全新的故事。这样，虽然你没有带进任何新书籍，但你仍然能够读到你想要的故事。

这个比喻就像是ROP攻击。在这种攻击中，黑客（就像那个想读新故事的人）不会试图在计算机系统中引入新的代码（就像不带新书进图书馆）。相反，他们会利用已经存在于系统中的小代码片段（就像图书馆中已有的书籍的句子）。通过巧妙地重新排列这些代码片段的执行顺序，黑客可以让计算机执行他们想要的操作，就像重新排列句子来讲述一个新故事一样。

这种攻击方式很难被防范，因为黑客没有引入新的代码，而是在利用系统中已经存在、本身合法的代码。

好的，让我们用一个简化的例子来说明ROP攻击的概念。假设有一个非常简单的程序，它包含几个函数和一个易受攻击的点，比如栈溢出漏洞。

程序的结构如下：

1. `main()` 函数：程序的入口点。
2. `vulnerableFunction()` 函数：包含栈溢出漏洞的函数。
3. 一些简单的函数，如 `funcA()` 执行操作 A，`funcB()` 执行操作 B，等等。

现在，假设每个函数 `funcA()`、`funcB()` 等在执行其操作后有一个返回指令。在正常情况下，这些函数被 `main()` 或其他函数调用，并在完成后返回到它们被调用的地方。

但是，如果 `vulnerableFunction()` 存在栈溢出的问题，攻击者可以利用这一点来改变程序的执行流程。这是怎么做的呢？

1. **栈溢出**：攻击者通过给 `vulnerableFunction()` 输入过长的数据，溢出其栈空间，这允许他们覆盖存储在栈上的返回地址。

2. **控制流劫持**：攻击者不是随意设置返回地址，而是仔细选择地址，这些地址指向 `funcA()`、`funcB()` 等函数中的特定点（这些点被称为“小工具”）。

3. **执行“小工具链”**：当 `vulnerableFunction()` 尝试返回时，由于返回地址已被修改，程序跳转到 `funcA()` 的中间，执行一些操作，然后跳到 `funcB()`，如此类推。这样，攻击者就可以组合这些小片段的功能，执行一系列复杂的操作，最终达到其恶意目的，例如执行未授权的命令或绕过安全检查。

举个具体的例子：

- `funcA()` 可能只是简单地将一个值移动到寄存器。
- `funcB()` 可能执行加法操作。

攻击者可能会这样安排：首先使用 `funcA()` 设置一个特定的值，然后使用 `funcB()` 对该值进行操作。通过这种方式，即使他们无法直接在程序中执行任何新代码，也能“编写”一个完全由现有代码片段组成的小程序，从而实现攻击目标。


# Reference
1. https://evilpan.com/2018/03/17/exploit-the-stack/
2. https://www.cs.uaf.edu/2008/fall/cs301/support/x86/


